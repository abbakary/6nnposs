<!-- Unified Invoice Upload & Extraction Modal - Reusable for all order pages -->
<div class="modal fade" id="uploadInvoiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-light border-bottom">
        <h5 class="modal-title">
          <i class="fa fa-file-invoice me-2"></i>Create Invoice for Order {{ order.order_number }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="manualInvoiceForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_invoice_manual">
        <input type="hidden" name="selected_order_id" value="{{ order.id }}">
        {% if vehicle and vehicle.plate_number %}<input type="hidden" name="plate" value="{{ vehicle.plate_number }}">{% endif %}
        {% if order.customer %}<input type="hidden" name="customer_id" value="{{ order.customer.id }}">{% endif %}
        
        <!-- Hidden fields for additional details -->
        <input type="hidden" name="payment_method" id="hiddenPaymentMethod" value="">
        <input type="hidden" name="delivery_terms" id="hiddenDeliveryTerms" value="">
        <input type="hidden" name="attended_by" id="hiddenAttendedBy" value="">
        <input type="hidden" name="kind_attention" id="hiddenKindAttention" value="">
        <input type="hidden" name="remarks" id="hiddenRemarks" value="">
        <input type="hidden" name="notes" id="hiddenNotes" value="">

        <!-- Quick Info Bar -->
        <div class="alert alert-info mb-3 border-0" role="alert">
          <div class="d-flex align-items-center">
            <i class="fa fa-lightbulb me-3" style="font-size: 18px;"></i>
            <div>
              <strong>Tip:</strong> Upload a PDF invoice to auto-extract data, or fill in the form manually. All fields are editable.
            </div>
          </div>
        </div>

        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <!-- Upload Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-file-upload me-2"></i>Upload PDF (Optional)</strong>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Select PDF File</label>
                <input type="file" id="startedOrderInvoiceFile" class="form-control" accept=".pdf" data-max-file-size="50485760">
                <small class="text-muted">PDF files only. Max 50MB. Leave empty to enter data manually.</small>
              </div>

              <div id="startedUploadError" class="alert alert-danger" style="display:none" role="alert"></div>
              <div id="extractionSuccess" class="alert alert-success" style="display:none" role="alert">
                <i class="fa fa-check-circle me-2"></i>Data extracted successfully! The form below has been auto-populated.
              </div>
              <div id="startedUploadProgress" class="progress" style="display:none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="startedUploadProgressBar" role="progressbar" style="width: 0%"></div>
              </div>

              <button type="button" id="startedUploadBtn" class="btn btn-primary">
                <i class="fa fa-upload me-2"></i>Upload & Extract
              </button>
            </div>
          </div>

          <!-- Hidden fields for extracted monetary values and seller info -->
          <div id="extractedHiddenFields"></div>

          <!-- Extracted Data Preview -->
          <div id="uploadedInvoicePreview" style="display:none;" class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-check-circle me-2 text-success"></i>Extracted Data Preview</strong>
              <small class="text-muted ms-2">Edit the fields below as needed</small>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
              <div class="row g-2">
                <div class="col-md-6">
                  <small class="text-muted d-block">Customer Name</small>
                  <p id="previewCustomerName" class="mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Phone</small>
                  <p id="previewCustomerPhone" class="mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Email</small>
                  <p id="previewCustomerEmail" class="mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Address</small>
                  <p id="previewCustomerAddress" class="mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Invoice Number / PI No</small>
                  <p id="previewInvoiceNo" class="mb-2"><strong>-</strong></p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Invoice Date</small>
                  <p id="previewInvoiceDate" class="mb-2"><strong>-</strong></p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Code No</small>
                  <p id="previewCodeNo" class="mb-2">-</p>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Reference</small>
                  <p id="previewReference" class="mb-2">-</p>
                </div>
                <div class="col-md-4">
                  <small class="text-muted d-block">Subtotal</small>
                  <p id="previewSubtotal" class="mb-0">-</p>
                </div>
                <div class="col-md-4">
                  <small class="text-muted d-block">Tax/VAT</small>
                  <p id="previewTax" class="mb-0">-</p>
                </div>
                <div class="col-md-4">
                  <small class="text-muted d-block">Total</small>
                  <p id="previewTotal" class="mb-0 fs-6"><strong>-</strong></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Line Items (Extracted) -->
          <div id="extractedLineItemsSection" class="card mb-3" style="display:none;">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <div>
                <strong><i class="fa fa-list me-2"></i>Line Items</strong>
                <small class="text-muted ms-2">Review and adjust quantities and prices</small>
              </div>
              <button type="button" id="addLineItemRowBtn" class="btn btn-sm btn-outline-primary">
                <i class="fa fa-plus me-1"></i>Add Row
              </button>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0 line-items-table">
                  <thead class="table-light">
                    <tr style="background-color: #f8f9fa;">
                      <th class="line-item-col-num">#</th>
                      <th class="line-item-col-code">Code</th>
                      <th class="line-item-col-desc">Description</th>
                      <th class="line-item-col-unit">Unit</th>
                      <th class="line-item-col-qty">Qty</th>
                      <th class="line-item-col-rate">Unit Price</th>
                      <th class="line-item-col-actions">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="lineItemRowsBody" class="line-items-body"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Existing Customer Alert -->
          <div id="existingCustomerAlert" class="alert alert-info alert-dismissible fade show mb-3" style="display:none;">
            <i class="fa fa-info-circle me-2"></i>
            <strong>Existing Customer Found!</strong> A customer with this phone number already exists.
            <span id="existingCustomerName"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>

          <!-- Customer Information Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-user me-2"></i>Customer Information</strong>
            </div>
            <div class="card-body">
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label">Full Name *</label>
                  <input type="text" name="customer_name" class="form-control" id="manualCustomerName" value="{{ order.customer.full_name }}" placeholder="Customer full name" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Phone <small class="text-muted">(optional)</small></label>
                  <input type="tel" name="customer_phone" class="form-control" id="manualCustomerPhone" placeholder="Phone number" value="{{ order.customer.phone|default:'' }}">
                </div>
              </div>
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label">Email</label>
                  <input type="email" name="customer_email" class="form-control" placeholder="email@example.com" value="{{ order.customer.email|default:'' }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Customer Type *</label>
                  <select name="customer_type" id="invoiceCustomerType" class="form-select" required>
                    <option value="">Select customer type</option>
                    <option value="personal" {% if order.customer.customer_type == 'personal' %}selected{% endif %}>Personal</option>
                    <option value="company" {% if order.customer.customer_type == 'company' %}selected{% endif %}>Private Company</option>
                    <option value="ngo" {% if order.customer.customer_type == 'ngo' %}selected{% endif %}>NGO</option>
                    <option value="government" {% if order.customer.customer_type == 'government' %}selected{% endif %}>Government</option>
                  </select>
                </div>
              </div>
              
              <!-- Personal Subtype (shown only for personal type) -->
              <div class="row mb-2" id="personalSubtypeWrapper" style="display:none;">
                <div class="col-md-6">
                  <label class="form-label">Personal Subtype</label>
                  <select name="customer_personal_subtype" class="form-select">
                    <option value="">Select subtype</option>
                    <option value="owner">Owner</option>
                    <option value="driver">Driver</option>
                  </select>
                </div>
              </div>

              <!-- Organization Fields (shown for non-personal types) -->
              <div class="row mb-2" id="organizationDetailsWrapper" style="display:none;">
                <div class="col-md-6">
                  <label class="form-label">Organization Name</label>
                  <input type="text" name="customer_organization_name" class="form-control" id="organizationNameField" placeholder="Organization name" value="{{ order.customer.organization_name|default:'' }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tax Number</label>
                  <input type="text" name="customer_tax_number" class="form-control" id="taxNumberField" placeholder="Tax identification number" value="{{ order.customer.tax_number|default:'' }}">
                </div>
              </div>

              <div class="row mb-2">
                <div class="col-md-12">
                  <label class="form-label">Address</label>
                  <input type="text" name="customer_address" class="form-control" placeholder="Customer address" value="{{ order.customer.address|default:'' }}">
                </div>
              </div>
            </div>
          </div>

          <!-- Invoice Information Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-file-invoice me-2"></i>Invoice Information</strong>
            </div>
            <div class="card-body">
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Invoice Number / PI No</label>
                  <input type="text" name="invoice_number" class="form-control" id="invoiceNumberField" placeholder="e.g., INV-001 or PI-1765632">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Invoice Date</label>
                  <input type="date" name="invoice_date" class="form-control" value="{% now 'Y-m-d' %}" required>
                </div>
              </div>
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label">Code No. <small class="text-muted">(optional)</small></label>
                  <input type="text" name="code_no" class="form-control" id="codeNoField" placeholder="e.g., A01696">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Reference <small class="text-muted">(optional)</small></label>
                  <input type="text" name="reference" class="form-control" id="referenceField" placeholder="e.g., T 211 EDF">
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Information Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-money me-2"></i>Payment Information</strong>
            </div>
            <div class="card-body">
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Subtotal</label>
                  <div class="input-group">
                    <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                    <input type="number" name="subtotal" class="form-control" step="0.01" min="0" placeholder="0.00">
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Tax/VAT</label>
                  <div class="input-group">
                    <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                    <input type="number" name="tax_amount" class="form-control" step="0.01" min="0" placeholder="0.00">
                  </div>
                </div>
              </div>

              <div class="row mb-2">
                <div class="col-md-12">
                  <label class="form-label fw-bold">Total Amount *</label>
                  <div class="input-group">
                    <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                    <input type="number" name="total_amount" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 20px; background: #f8f9fa;">
          <div class="text-center w-100 mb-3">
            <p class="text-muted small mb-0">
              <i class="fa fa-info-circle me-1"></i>
              Fill in the required fields (marked with *), then click the button below to create the invoice.
            </p>
          </div>
          <div class="w-100 d-flex gap-2" style="margin-top: -15px;">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fa fa-times me-2"></i>Cancel
            </button>
            <button type="button" id="addAnotherServiceBtn" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#addServiceItemModal">
              <i class="fa fa-plus me-2"></i>Add Item/Service
            </button>
            <button type="submit" class="btn btn-success btn-lg flex-grow-1" style="font-weight: 600;">
              <i class="fa fa-check-circle me-2"></i>Create Invoice
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Service/Item Modal -->
<div class="modal fade" id="addServiceItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-info text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fa fa-plus-circle me-3 fa-lg"></i>
          <div>
            <h5 class="modal-title fw-bold mb-0">Add Another Item/Service</h5>
            <small class="opacity-75">Add additional service or item to this order</small>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addServiceItemForm" method="post" action="{% url 'tracker:api_update_order_from_extraction' %}">
        {% csrf_token %}
        <input type="hidden" name="order_id" value="{{ order.id }}">
        <input type="hidden" name="add_component" value="true">

        <div class="modal-body p-4">
          <div class="row g-3">
            <!-- Component Type Selection -->
            <div class="col-12">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fa fa-layer-group me-2"></i>Service/Item Type <span class="text-danger">*</span>
              </label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="component_type" id="componentService" value="service" checked>
                <label class="btn btn-outline-primary fw-semibold" for="componentService" style="flex: 1;">
                  <i class="fa fa-wrench me-2"></i>Service
                </label>

                <input type="radio" class="btn-check" name="component_type" id="componentSales" value="sales">
                <label class="btn btn-outline-success fw-semibold" for="componentSales" style="flex: 1;">
                  <i class="fa fa-shopping-cart me-2"></i>Sales/Item
                </label>
              </div>
            </div>

            <!-- Sales Item Details (shown when Sales is selected) -->
            <div id="salesItemDetails" style="display: none;">
              <div class="col-12">
                <label class="form-label fw-medium text-dark">
                  <i class="fa fa-tag me-2"></i>Item Name <span class="text-danger">*</span>
                </label>
                <input type="text" name="component_item_name" class="form-control" placeholder="e.g., Tire, Battery, Oil, etc.">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium text-dark">
                  <i class="fa fa-building me-2"></i>Brand
                </label>
                <input type="text" name="component_brand" class="form-control" placeholder="e.g., Michelin, Bosch, etc.">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium text-dark">
                  <i class="fa fa-cubes me-2"></i>Quantity
                </label>
                <input type="number" name="component_quantity" class="form-control" placeholder="e.g., 4" min="1" value="1">
              </div>
              <div class="col-12">
                <label class="form-label fw-medium text-dark">
                  <i class="fa fa-cog me-2"></i>Tire Type <small class="text-muted">(if applicable)</small>
                </label>
                <select name="component_tire_type" class="form-select">
                  <option value="New">New</option>
                  <option value="Used">Used</option>
                  <option value="Refurbished">Refurbished</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>

            <!-- Reason for adding -->
            <div class="col-12">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fa fa-comment-alt me-2"></i>Reason for Adding <span class="text-danger">*</span>
              </label>
              <textarea name="component_reason" class="form-control" rows="3" placeholder="e.g., Additional repair found, customer requested, replacement part needed, warranty service, etc." required></textarea>
              <small class="text-muted d-block mt-1">Explain why this item/service is being added to the order</small>
            </div>

            <!-- Additional Notes -->
            <div class="col-12">
              <label class="form-label fw-medium text-dark mb-2">
                <i class="fa fa-clipboard me-2"></i>Additional Notes <small class="text-muted">(optional)</small>
              </label>
              <textarea name="component_notes" class="form-control" rows="2" placeholder="Any additional details or specifications..."></textarea>
            </div>
          </div>

          <div class="alert alert-light border-start border-4 border-info mt-3 mb-0">
            <i class="fa fa-info-circle me-2 text-info"></i>
            <strong>Note:</strong> This item/service will be added as a component to the current order. You can add multiple items before completing the order.
          </div>
        </div>

        <div class="modal-footer bg-light border-top">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fa fa-times me-2"></i>Cancel
          </button>
          <button type="button" class="btn btn-info" id="addAnotherItemBtn">
            <i class="fa fa-plus me-2"></i>Add & Continue
          </button>
          <button type="submit" class="btn btn-success fw-bold">
            <i class="fa fa-check-circle me-2"></i>Add & Close
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function() {
  const componentServiceRadio = document.getElementById('componentService');
  const componentSalesRadio = document.getElementById('componentSales');
  const salesItemDetails = document.getElementById('salesItemDetails');
  const addServiceItemForm = document.getElementById('addServiceItemForm');
  const addAnotherItemBtn = document.getElementById('addAnotherItemBtn');

  // Show/hide sales item details based on selection
  function toggleSalesDetails() {
    if (componentSalesRadio.checked) {
      salesItemDetails.style.display = 'block';
      document.querySelector('[name="component_item_name"]').required = true;
    } else {
      salesItemDetails.style.display = 'none';
      document.querySelector('[name="component_item_name"]').required = false;
    }
  }

  componentServiceRadio.addEventListener('change', toggleSalesDetails);
  componentSalesRadio.addEventListener('change', toggleSalesDetails);

  // Handle "Add & Continue" button
  addAnotherItemBtn.addEventListener('click', function(e) {
    e.preventDefault();

    // Validate required fields
    const reason = document.querySelector('[name="component_reason"]').value.trim();
    if (!reason) {
      alert('Please provide a reason for adding this item/service');
      return;
    }

    if (componentSalesRadio.checked) {
      const itemName = document.querySelector('[name="component_item_name"]').value.trim();
      if (!itemName) {
        alert('Please provide the item name');
        return;
      }
    }

    // Submit form silently and reset
    const formData = new FormData(addServiceItemForm);
    fetch(addServiceItemForm.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'alert alert-success alert-dismissible fade show';
        successMsg.innerHTML = `
          <i class="fa fa-check-circle me-2"></i>
          <strong>Item/Service added successfully!</strong> You can add another one or close this dialog.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        addServiceItemForm.insertBefore(successMsg, addServiceItemForm.firstChild);

        // Reset form for next entry
        addServiceItemForm.reset();
        componentServiceRadio.checked = true;
        toggleSalesDetails();

        // Auto-dismiss success message after 4 seconds
        setTimeout(() => {
          successMsg.remove();
        }, 4000);
      } else {
        alert('Error: ' + (data.error || 'Failed to add item'));
      }
    })
    .catch(err => {
      console.error('Error:', err);
      alert('Failed to add item. Please try again.');
    });
  });

  // Initialize on load
  toggleSalesDetails();
})();
</script>

<style>
/* Line items table - proper layout that handles long descriptions */
.line-items-table {
  font-size: 0.85rem;
  width: 100%;
  table-layout: fixed;
}

.line-items-table thead {
  background-color: #f8f9fa;
  position: sticky;
  top: 0;
}

.line-items-table th,
.line-items-table td {
  padding: 0.6rem 0.4rem;
  vertical-align: middle;
  border: 1px solid #dee2e6;
}

.line-items-table th {
  font-weight: 600;
  text-align: left;
  background-color: #f8f9fa;
}

/* Column width definitions - using percentages for fixed layout */
.line-item-col-num {
  width: 5%;
  text-align: center;
}

.line-item-col-code {
  width: 12%;
}

.line-item-col-desc {
  width: 40%;
  word-break: break-word;
  white-space: normal;
  overflow-wrap: break-word;
}

.line-item-col-unit {
  width: 10%;
}

.line-item-col-qty {
  width: 10%;
}

.line-item-col-rate {
  width: 15%;
}

.line-item-col-actions {
  width: 8%;
  text-align: center;
}

/* Input styling within table */
.line-items-table input[type="text"],
.line-items-table input[type="number"] {
  width: 100%;
  padding: 0.4rem 0.3rem;
  font-size: 0.85rem;
  border: 1px solid #dee2e6;
  border-radius: 0.25rem;
  font-family: inherit;
}

.line-items-table input[type="text"]::placeholder,
.line-items-table input[type="number"]::placeholder {
  font-size: 0.8rem;
  color: #999;
}

.line-items-table input[type="text"]:focus,
.line-items-table input[type="number"]:focus {
  border-color: #80bdff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  outline: none;
}

/* Button styling */
.line-items-table .remove-line-item {
  padding: 0.3rem 0.5rem;
  font-size: 1rem;
  line-height: 1;
  border: 1px solid #dc3545;
  background-color: white;
  color: #dc3545;
  cursor: pointer;
}

.line-items-table .remove-line-item:hover {
  background-color: #dc3545;
  color: white;
}

/* Body styling for consistent row heights */
.line-items-body tr {
  height: auto;
}

/* Ensure descriptions wrap and don't overflow */
.line-items-table .line-item-col-desc {
  max-width: 0;
  overflow-wrap: break-word;
  word-wrap: break-word;
  white-space: pre-wrap;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
  .line-items-table {
    font-size: 0.8rem;
  }

  .line-item-col-desc {
    width: 35%;
  }

  .line-item-col-code {
    width: 10%;
  }

  .line-item-col-rate {
    width: 12%;
  }
}

@media (max-width: 768px) {
  .line-items-table {
    font-size: 0.75rem;
  }

  .line-items-table th,
  .line-items-table td {
    padding: 0.4rem 0.25rem;
  }

  .line-items-table input[type="text"],
  .line-items-table input[type="number"] {
    padding: 0.3rem 0.2rem;
    font-size: 0.75rem;
  }

  .line-item-col-num {
    width: 6%;
  }

  .line-item-col-code {
    width: 10%;
  }

  .line-item-col-desc {
    width: 30%;
  }

  .line-item-col-unit {
    width: 8%;
  }

  .line-item-col-qty {
    width: 8%;
  }

  .line-item-col-rate {
    width: 12%;
  }

  .line-item-col-actions {
    width: 10%;
  }
}
</style>

<script>
// Invoice Upload Modal - Extraction Handler
(function() {
  const fileInput = document.getElementById('startedOrderInvoiceFile');
  const uploadBtn = document.getElementById('startedUploadBtn');
  const errorBox = document.getElementById('startedUploadError');
  const successMsg = document.getElementById('extractionSuccess');
  const progressWrap = document.getElementById('startedUploadProgress');
  const progressBar = document.getElementById('startedUploadProgressBar');
  const previewSection = document.getElementById('uploadedInvoicePreview');
  const lineItemsSection = document.getElementById('extractedLineItemsSection');
  const lineItemsBody = document.getElementById('lineItemRowsBody');
  const hiddenFieldsDiv = document.getElementById('extractedHiddenFields');
  const manualForm = document.getElementById('manualInvoiceForm');

  if (!uploadBtn) return;

  function getCSRF() {
    const name = 'csrftoken=';
    const parts = document.cookie.split(';');
    for (let i = 0; i < parts.length; i++) {
      const c = parts[i].trim();
      if (c.indexOf(name) === 0) return c.substring(name.length);
    }
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
  }

  function setProgress(p) {
    if (progressBar) progressBar.style.width = Math.max(0, Math.min(100, p)) + '%';
    if (progressWrap) progressWrap.style.display = p > 0 && p < 100 ? 'block' : (p >= 100 ? 'block' : 'none');
  }

  uploadBtn.addEventListener('click', async function() {
    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
      errorBox.style.display = 'block';
      errorBox.innerHTML = '<i class="fa fa-warning me-2"></i>Please select a PDF file to upload.';
      errorBox.className = 'alert alert-warning';
      successMsg.style.display = 'none';
      return;
    }

    const file = fileInput.files[0];
    if (file.size > 50 * 1024 * 1024) {
      errorBox.style.display = 'block';
      errorBox.innerHTML = '<i class="fa fa-warning me-2"></i>File is too large. Maximum size is 50MB.';
      errorBox.className = 'alert alert-warning';
      return;
    }

    errorBox.style.display = 'none';
    successMsg.style.display = 'none';
    setProgress(5);
    uploadBtn.disabled = true;
    const originalText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Extracting...';

    try {
      const formData = new FormData();
      formData.append('file', file);

      const plateField = manualForm.querySelector('[name="plate"]');
      if (plateField && plateField.value) {
        formData.append('plate', plateField.value);
      }

      const orderIdField = manualForm.querySelector('[name="selected_order_id"]');
      if (orderIdField && orderIdField.value) {
        formData.append('selected_order_id', orderIdField.value);
      }

      const customerIdField = manualForm.querySelector('[name="customer_id"]');
      if (customerIdField && customerIdField.value) {
        formData.append('pre_selected_customer_id', customerIdField.value);
      }

      setProgress(10);

      const response = await fetch('{% url "tracker:api_upload_extract_invoice" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCSRF()
        }
      });

      setProgress(90);

      if (!response.ok) {
        throw new Error(`Server error: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();

      if (!data || !data.success) {
        throw new Error(data?.message || 'Extraction failed');
      }

      setProgress(100);

      // Populate preview
      const header = data.header || {};
      populatePreview(header);

      // Populate line items
      const items = data.items || [];
      populateLineItems(items);

      // Populate form fields
      populateFormFields(header);

      // Show success
      successMsg.style.display = 'block';
      previewSection.style.display = 'block';
      if (items.length > 0) {
        lineItemsSection.style.display = 'block';
      }

      errorBox.style.display = 'none';

    } catch (err) {
      setProgress(0);
      errorBox.style.display = 'block';
      errorBox.innerHTML = '<i class="fa fa-exclamation-triangle me-2"></i>' + (err?.message || 'Upload failed');
      errorBox.className = 'alert alert-danger';
      successMsg.style.display = 'none';
      console.error('Extraction error:', err);
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = originalText;
      setProgress(0);
    }
  });

  function populatePreview(header) {
    const map = {
      'previewCustomerName': 'customer_name',
      'previewCustomerPhone': 'phone',
      'previewCustomerEmail': 'email',
      'previewCustomerAddress': 'address',
      'previewInvoiceNo': 'invoice_no',
      'previewInvoiceDate': 'date',
      'previewCodeNo': 'code_no',
      'previewReference': 'reference'
    };

    Object.keys(map).forEach(elementId => {
      const el = document.getElementById(elementId);
      if (el) {
        const value = header[map[elementId]] || '-';
        el.textContent = value;
      }
    });

    if (document.getElementById('previewSubtotal')) {
      const subtotal = header.subtotal || 0;
      document.getElementById('previewSubtotal').textContent = parseFloat(subtotal).toLocaleString('en-US', { minimumFractionDigits: 2 });
    }

    if (document.getElementById('previewTax')) {
      const tax = header.tax || 0;
      document.getElementById('previewTax').textContent = parseFloat(tax).toLocaleString('en-US', { minimumFractionDigits: 2 });
    }

    if (document.getElementById('previewTotal')) {
      const total = header.total || 0;
      document.getElementById('previewTotal').textContent = parseFloat(total).toLocaleString('en-US', { minimumFractionDigits: 2 });
    }
  }

  function populateLineItems(items) {
    lineItemsBody.innerHTML = '';
    hiddenFieldsDiv.innerHTML = '';

    if (!items || items.length === 0) {
      lineItemsSection.style.display = 'none';
      return;
    }

    lineItemsSection.style.display = 'block';

    items.forEach((item, idx) => {
      const code = item.code || '';
      const desc = item.description || '';
      const unit = item.unit || '';
      const qty = item.qty || 1;
      const rate = item.rate || 0;
      const value = item.value || (qty * rate);

      // Create table row
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="text-center"><small>${idx + 1}</small></td>
        <td><small>${code || '-'}</small></td>
        <td><small>${desc}</small></td>
        <td><small>${unit || '-'}</small></td>
        <td><input type="number" class="form-control form-control-sm" value="${qty}" min="1" data-item-index="${idx}"></td>
        <td><input type="number" class="form-control form-control-sm" value="${rate.toFixed(2)}" step="0.01" min="0" data-item-index="${idx}"></td>
        <td class="text-center"><button type="button" class="btn btn-sm btn-danger remove-line-item" data-item-index="${idx}"><i class="fa fa-trash"></i></button></td>
      `;
      lineItemsBody.appendChild(row);

      // Create hidden form fields
      const fields = [
        { name: 'item_code[]', value: code },
        { name: 'item_description[]', value: desc },
        { name: 'item_unit[]', value: unit },
        { name: 'item_qty[]', value: qty },
        { name: 'item_price[]', value: rate }
      ];

      fields.forEach(field => {
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = field.name;
        inp.value = field.value;
        inp.dataset.itemIndex = idx;
        hiddenFieldsDiv.appendChild(inp);
      });
    });

    // Attach remove button handlers
    document.querySelectorAll('.remove-line-item').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const idx = this.dataset.itemIndex;
        document.querySelectorAll(`tr[data-item-index="${idx}"]`).forEach(el => el.remove());
        document.querySelectorAll(`input[data-item-index="${idx}"]`).forEach(el => el.remove());
      });
    });

    // Add row data update listeners
    document.querySelectorAll('.line-items-body input').forEach(input => {
      input.addEventListener('change', function() {
        const idx = this.dataset.itemIndex;
        const hiddenInputs = hiddenFieldsDiv.querySelectorAll(`input[data-item-index="${idx}"]`);

        // Update corresponding hidden field based on column
        if (this.classList.contains('qty-input')) {
          const qtyField = Array.from(hiddenInputs).find(i => i.name === 'item_qty[]');
          if (qtyField) qtyField.value = this.value;
        } else if (this.classList.contains('rate-input')) {
          const rateField = Array.from(hiddenInputs).find(i => i.name === 'item_price[]');
          if (rateField) rateField.value = this.value;
        }
      });
    });
  }

  function populateFormFields(header) {
    const fieldMap = {
      'manualCustomerName': 'customer_name',
      'manualCustomerPhone': 'phone',
      'invoiceNumberField': 'invoice_no',
      'codeNoField': 'code_no',
      'referenceField': 'reference'
    };

    Object.keys(fieldMap).forEach(inputId => {
      const el = manualForm.querySelector('[id="' + inputId + '"]');
      if (el) {
        const value = header[fieldMap[inputId]] || '';
        el.value = value;
      }
    });

    // Set address
    const addressInput = manualForm.querySelector('[name="customer_address"]');
    if (addressInput) {
      addressInput.value = header.address || '';
    }

    // Set email
    const emailInput = manualForm.querySelector('[name="customer_email"]');
    if (emailInput) {
      emailInput.value = header.email || '';
    }

    // Set invoice date
    const dateInput = manualForm.querySelector('[name="invoice_date"]');
    if (dateInput && header.date) {
      let formattedDate = header.date;
      const dateMatch = String(header.date).match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      if (dateMatch) {
        formattedDate = dateMatch[3] + '-' + String(dateMatch[2]).padStart(2, '0') + '-' + String(dateMatch[1]).padStart(2, '0');
      }
      dateInput.value = formattedDate;
    }

    // Set monetary values
    const subtotalInput = manualForm.querySelector('[name="subtotal"]');
    const taxInput = manualForm.querySelector('[name="tax_amount"]');
    const totalInput = manualForm.querySelector('[name="total_amount"]');

    if (subtotalInput) subtotalInput.value = header.subtotal || 0;
    if (taxInput) taxInput.value = header.tax || 0;
    if (totalInput) totalInput.value = header.total || 0;

    // Store seller and additional info in hidden fields
    const sellerKeys = ['seller_name', 'seller_address', 'seller_phone', 'seller_email', 'seller_tax_id', 'seller_vat_reg'];
    sellerKeys.forEach(key => {
      if (header[key]) {
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = key;
        inp.value = header[key];
        hiddenFieldsDiv.appendChild(inp);
      }
    });
  }
})();
</script>
